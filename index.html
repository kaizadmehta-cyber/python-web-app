<!DOCTYPE html>
<html>
  <head>
    <title>Defect Analysis Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

    <style>
      :root {
        --primary: #0f172a; --secondary: #334155; --accent: #3b82f6; 
        --bg: #f1f5f9; --card-bg: #ffffff; --border: #cbd5e1;
        --text: #1e293b; --muted: #64748b;
        --danger: #ef4444; --warning: #f59e0b; --success: #22c55e;
        --shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        --radius: 8px;
      }
      body { margin:0; font-family:'Inter', sans-serif; background:var(--bg); color:var(--text); padding:20px; }
      
      /* --- HEADER --- */
      .header-container { background:white; border-radius:var(--radius); box-shadow:var(--shadow); padding:20px; margin-bottom:20px; display:flex; justify-content:space-between; align-items:flex-start; }
      .brand-section h1 { margin:0; font-size:24px; font-weight:800; color:var(--primary); margin-bottom:10px; }
      .meta-info { display:flex; gap:20px; font-size:12px; color:var(--secondary); }
      .meta-item { display:flex; flex-direction:column; }
      .meta-item span:first-child { font-weight:600; color:var(--muted); text-transform:uppercase; font-size:10px; }
      .meta-item span:last-child { font-weight:700; color:var(--primary); font-size:13px; }
      .actions { display:flex; gap:10px; align-items:center; }
      .actions button { padding:8px 16px; border:1px solid var(--border); background:white; border-radius:6px; cursor:pointer; font-weight:600; color:var(--secondary); transition:0.2s; height:36px; }
      .actions button:hover { background:#e2e8f0; }
      .actions button.primary { background:var(--primary); color:white; border-color:var(--primary); }

      /* --- SECTIONS --- */
      .section-label { font-size: 13px; font-weight: 700; color: var(--secondary); margin: 0 0 10px 0; text-transform: uppercase; display: flex; align-items: center; gap: 8px; }
      .section-label::after { content:''; flex:1; height:1px; background:var(--border); opacity:0.5; }

      /* --- KPI LAYOUTS --- */
      .lifecycle-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:15px; margin-bottom:25px; }
      .open-defects-wrapper { background: white; border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; box-shadow: var(--shadow); margin-bottom: 25px; }
      .open-defects-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(160px, 1fr)); gap:15px; margin-top:15px;}
      
      .kpi-card { background:white; padding:15px; border-radius:var(--radius); box-shadow:var(--shadow); cursor:pointer; text-align:center; transition:transform 0.1s; border:1px solid transparent; }
      .open-defects-wrapper .kpi-card { box-shadow: none; border: 1px solid #e2e8f0; background: #f8fafc; }
      .open-defects-wrapper .kpi-card:hover { border-color: var(--accent); background: white; }
      .kpi-card:hover { transform:translateY(-3px); border-color:var(--accent); }
      .kpi-val { font-size:28px; font-weight:800; color:var(--primary); }
      .kpi-lbl { font-size:11px; font-weight:600; color:var(--muted); text-transform:uppercase; margin-top:5px; }

      /* --- STRATEGIC INSIGHTS GRID --- */
      .insights-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-bottom: 25px; }
      .insight-card { background: white; padding: 15px; border-radius: var(--radius); box-shadow: var(--shadow); border: 1px solid var(--border); }
      .insight-title { font-weight: 700; font-size: 13px; color: var(--secondary); margin-bottom: 15px; border-bottom: 1px solid #f1f5f9; padding-bottom: 5px; }
      
      /* Heatmap Table */
      .heatmap-table { width: 100%; border-collapse: collapse; font-size: 11px; }
      .heatmap-table th { text-align: left; padding: 8px; background: #f8fafc; border-bottom: 2px solid var(--border); }
      .heatmap-table td { padding: 8px; border-bottom: 1px solid #f1f5f9; text-align: center; font-weight: 600; cursor: pointer; transition: 0.1s; }
      .heatmap-table td:first-child { text-align: left; font-weight: 700; color: var(--secondary); }
      .heatmap-table td:hover { transform: scale(1.1); box-shadow: 0 0 5px rgba(0,0,0,0.2); }

      /* Watchlist Table */
      .watchlist-table { width: 100%; border-collapse: collapse; font-size: 11px; }
      .watchlist-table th { text-align: left; padding: 6px; background: #fee2e2; color: #991b1b; }
      .watchlist-table td { padding: 6px; border-bottom: 1px solid #fecaca; color: #7f1d1d; }
      .watchlist-row:hover { background: #fef2f2; cursor: pointer; }

      /* --- FILTERS --- */
      .filter-bar { background:white; padding:15px; border-radius:var(--radius); box-shadow:var(--shadow); margin-bottom:10px; display:flex; gap:10px; flex-wrap:wrap; align-items: flex-end; }
      .f-grp { display:flex; flex-direction:column; gap:4px; flex:1; min-width:140px; }
      .f-grp label { font-size:11px; font-weight:600; color:var(--muted); }
      select, input { padding:8px; border:1px solid var(--border); border-radius:4px; font-size:12px; width:100%; box-sizing:border-box; }
      
      /* Filter Chips */
      .chip-container { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 20px; min-height: 24px; }
      .chip { display: flex; align-items: center; gap: 6px; background: #e0f2fe; color: #0369a1; padding: 4px 10px; border-radius: 16px; font-size: 11px; font-weight: 600; border: 1px solid #bae6fd; }
      .chip-close { cursor: pointer; font-weight: 800; font-size: 14px; line-height: 1; }
      .chip-close:hover { color: #0c4a6e; }

      /* --- CHARTS --- */
      .charts-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap:20px; margin-bottom:20px; }
      .chart-card { background:white; padding:15px; border-radius:var(--radius); box-shadow:var(--shadow); height:320px; position:relative; }

      /* --- TABLE --- */
      .table-card { background:white; border-radius:var(--radius); box-shadow:var(--shadow); overflow:hidden; }
      .table-head { padding:15px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; }
      .table-controls { display:flex; gap:10px; align-items:center; font-size:12px; color:var(--muted); }
      .table-wrap { overflow-x:auto; max-height:400px; text-align: left; }
      table { width:100%; border-collapse:collapse; font-size:12px; white-space:nowrap; }
      th { background:#f8fafc; text-align:left; padding:12px; font-weight:700; color:var(--secondary); position:sticky; top:0; z-index:10; }
      td { padding:10px 12px; border-bottom:1px solid #f1f5f9; text-align:left; }
      tr:hover { background:#f8fafc; }
      
      .concrete-btn { background-color: var(--accent); color: white; border: none; border-radius: 4px; padding: 5px 10px; font-size: 11px; font-weight: 600; cursor: pointer; text-decoration: none; display: inline-block; }
      .concrete-btn:hover { background-color: #2563eb; }
      .clickable-key { color: var(--accent); font-weight:700; cursor: pointer; text-decoration:underline; }

      /* --- MODAL --- */
      .modal-overlay { position:fixed; inset:0; background:rgba(15,23,42,0.6); display:none; justify-content:center; align-items:center; z-index:1000; backdrop-filter:blur(2px); }
      .modal-box { background:white; width:90%; max-width:1100px; max-height:90vh; border-radius:var(--radius); display:flex; flex-direction:column; overflow:hidden; box-shadow:0 20px 25px -5px rgba(0,0,0,0.1); }
      .modal-header { padding:15px 20px; background:#f8fafc; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; }
      .modal-body { overflow-y:auto; flex:1; padding:0; }
      .close-btn { background:transparent; border:none; font-size:24px; cursor:pointer; color:var(--muted); }
    </style>
  </head>
  <body>

    <!-- Header -->
    <div class="header-container">
      <div class="brand-section">
        <h1 id="cfg-title">Defect Analysis Dashboard</h1>
        <div class="meta-info">
          <div class="meta-item"><span>Project</span><span id="cfg-proj">-</span></div>
          <div class="meta-item"><span>Test Manager</span><span id="cfg-mgr">-</span></div>
          <div class="meta-item"><span>Test Lead</span><span id="cfg-lead">-</span></div>
        </div>
      </div>
      <div class="actions">
        <span id="lastUpdated" style="font-size:10px; color:var(--muted); margin-right:10px;">Loading...</span>
        <button onclick="loadData()">âŸ³ Refresh</button>
        <button onclick="exportExcel()">ðŸ“Š Export CSV</button>
        <button class="primary" onclick="exportPDF('main')">â¬‡ Export PDF</button>
      </div>
    </div>

    <!-- Filters -->
    <div class="filter-bar">
      <!-- Standard Filters -->
      <div class="f-grp"><label>Product / Module</label><select id="f-module" onchange="render()"></select></div>
      <div class="f-grp"><label>Submodule</label><select id="f-submodule" onchange="render()"></select></div>
      <div class="f-grp"><label>Benzene</label><select id="f-benzene" onchange="render()"></select></div>
      <div class="f-grp"><label>Assignee</label><select id="f-assignee" onchange="render()"></select></div>
      <div class="f-grp"><label>Status</label><select id="f-status" onchange="render()"></select></div>
      <div class="f-grp"><label>Severity</label><select id="f-severity" onchange="render()"></select></div>
      <div class="f-grp"><label>Labels</label><select id="f-labels" onchange="render()"></select></div>
      
      <!-- Date Range (Standard Width) -->
      <div class="f-grp"><label>Created From</label><input type="date" id="f-start" onchange="render()"></div>
      <div class="f-grp"><label>Created To</label><input type="date" id="f-end" onchange="render()"></div>

      <!-- Search (Standard Width - Removed flex:1.5) -->
      <div class="f-grp">
        <label>Search (Type Key)</label>
        <input id="q" list="suggestions" placeholder="Search Key, Summary..." oninput="handleSearch(this)" onkeydown="checkEnter(event)">
        <datalist id="suggestions"></datalist>
      </div>
      
      <div class="f-grp" style="flex:0; min-width:auto; justify-content:flex-end;">
        <button onclick="resetFilters()" style="height:34px;">Reset</button>
      </div>
    </div>
    
    <!-- Active Filter Chips -->
    <div class="chip-container" id="chip-container"></div>

    <!-- 1. Lifecycle Summary -->
    <div class="section-label">Overall Status</div>
    <div class="lifecycle-grid">
      <div class="kpi-card" onclick="drillKPI('total')"><div class="kpi-val" id="k-total">-</div><div class="kpi-lbl">Total Defects</div></div>
      <div class="kpi-card" onclick="drillKPI('resolved')"><div class="kpi-val" id="k-resolved" style="color:#8b5cf6">-</div><div class="kpi-lbl">Resolved</div></div>
      <div class="kpi-card" onclick="drillKPI('closed')"><div class="kpi-val" id="k-closed" style="color:#64748b">-</div><div class="kpi-lbl">Closed</div></div>
    </div>

    <!-- 2. Open Defects Grouping -->
    <div class="open-defects-wrapper">
        <div class="section-label" style="margin:0;">Active Issues Breakdown</div>
        <div class="open-defects-grid">
            <div class="kpi-card" onclick="drillKPI('open')" style="border-left: 4px solid #f59e0b;">
                <div class="kpi-val" id="k-open" style="color:#f59e0b">-</div><div class="kpi-lbl">Total Open</div>
            </div>
            <div class="kpi-card" onclick="drillKPI('s1')"><div class="kpi-val" id="k-s1" style="color:#ef4444">-</div><div class="kpi-lbl">S1-Critical</div></div>
            <div class="kpi-card" onclick="drillKPI('s2')"><div class="kpi-val" id="k-s2" style="color:#f97316">-</div><div class="kpi-lbl">S2-Serious</div></div>
            <div class="kpi-card" onclick="drillKPI('s3')"><div class="kpi-val" id="k-s3" style="color:#eab308">-</div><div class="kpi-lbl">S3-Moderate</div></div>
            <div class="kpi-card" onclick="drillKPI('s4')"><div class="kpi-val" id="k-s4" style="color:#10b981">-</div><div class="kpi-lbl">S4-Tolerable</div></div>
            <div class="kpi-card" onclick="drillKPI('unassigned')"><div class="kpi-val" id="k-un">-</div><div class="kpi-lbl">Unassigned</div></div>
        </div>
    </div>

    <!-- 3. Strategic Insights -->
    <div class="section-label">Strategic Analysis</div>
    <div class="insights-grid">
       
       <!-- Risk Heatmap -->
       <div class="insight-card">
         <div class="insight-title">Risk Heatmap (Module vs Severity)</div>
         <div style="overflow-y:auto; max-height:250px;">
            <table class="heatmap-table" id="heatmap-tbl">
               <thead><tr><th>Module</th><th>S1</th><th>S2</th><th>S3</th><th>S4</th></tr></thead>
               <tbody></tbody>
            </table>
         </div>
       </div>

       <!-- SLA Watchlist -->
       <div class="insight-card">
         <div class="insight-title" style="color:#b91c1c;">ðŸš¨ SLA Watchlist (S1/S2 > 5 Days)</div>
         <div style="overflow-y:auto; max-height:250px;">
            <table class="watchlist-table" id="watchlist-tbl">
               <thead><tr><th>Key</th><th>Summary</th><th>Assignee</th><th>Age</th></tr></thead>
               <tbody></tbody>
            </table>
         </div>
       </div>
    </div>

    <!-- 4. Dynamic Charts -->
    <div class="section-label">Deep Dive Analysis</div>
    <div id="charts-container" class="charts-grid"></div>

    <!-- 5. Main Table -->
    <div class="table-card">
      <div class="table-head">
        <span style="font-weight:700; color:var(--primary);">Defect List</span>
        <div class="table-controls">
          <label>Show Rows:</label>
          <select id="row-limit" onchange="renderTable()" style="width:70px;">
            <option value="25" selected>25</option>
            <option value="50">50</option>
            <option value="100">100</option>
            <option value="100000">All</option>
          </select>
          <span id="table-count"></span>
        </div>
      </div>
      <div class="table-wrap">
        <table id="main-table">
          <thead><tr><th>Key</th><th>Summary</th><th>Module</th><th>Submodule</th><th>Benzene</th><th>Severity</th><th>Status</th><th>Assignee</th><th style="text-align:right">View</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Modal -->
    <div class="modal-overlay" id="drill-modal" onclick="closeModal()">
      <div class="modal-box" onclick="event.stopPropagation()">
        <div class="modal-header">
          <h3 style="margin:0; font-size:16px;" id="modal-title">Drill Down</h3>
          <div style="display:flex; gap:10px;">
            <button class="primary" onclick="exportPDF('modal')">â¬‡ Export This List</button>
            <button class="close-btn" onclick="closeModal()">&times;</button>
          </div>
        </div>
        <div class="modal-body">
          <table id="modal-table">
            <thead>
               <tr><th>Key</th><th>Summary</th><th>Status</th><th>Severity</th><th>Assignee</th><th>Module</th><th>Created</th><th style="text-align:right">View</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <script>
      let ALL_DATA=[], FILTERED_DATA=[], MODAL_DATA=[], CHARTS={};
      let CONFIG_PIVOTS = [];

      // Updated Keys matching Python output
      const KEYS = { 
        KEY: "Key", SUMMARY: "Summary", STATUS: "Status", SEV: "Severity", 
        ASSIGNEE: "Assignee", MODULE: "Product / Module", SUBMODULE: "Submodule", 
        CAT: "Issue Category", URL: "URL", CREATED: "Created", LABELS: "Labels",
        RES_DATE: "Resolution Date", RESOLUTION: "Resolution",
        BENZENE: "Benzene"  // <--- ADDED THIS KEY
      };
      
      const STATUS_CLOSED = ["closed", "done", "rejected", "resolved", "verified"];

      function loadData() {
        document.getElementById("lastUpdated").textContent = "Fetching...";
        fetch('/api/data')
            .then(response => response.json())
            .then(onDataLoaded)
            .catch(error => {
                console.error("Error:", error);
                alert("Failed to load data. Check console.");
            });
      }

      function onDataLoaded(res) {
        if(!res.ok) { alert(res.error); return; }
        
        if(res.config) {
            document.getElementById("cfg-title").innerText = res.config.title;
            document.getElementById("cfg-proj").innerText = res.config.project;
            document.getElementById("cfg-mgr").innerText = res.config.manager;
            document.getElementById("cfg-lead").innerText = res.config.lead;
        }

        if(res.pivots && res.pivots.length > 0) {
            CONFIG_PIVOTS = res.pivots; 
        }

        ALL_DATA = res.rows;
        document.getElementById("lastUpdated").innerText = `Updated: ${new Date().toLocaleTimeString()}`;
        
        populateDropdown("f-module", KEYS.MODULE); 
        populateDropdown("f-submodule", KEYS.SUBMODULE);
        populateDropdown("f-benzene", KEYS.BENZENE); // <--- ADDED POPULATE
        populateDropdown("f-assignee", KEYS.ASSIGNEE); 
        populateDropdown("f-status", KEYS.STATUS);
        populateDropdown("f-severity", KEYS.SEV); 
        populateDropdown("f-labels", KEYS.LABELS);
        
        render();
      }

      function populateDropdown(id, key) {
        const unique = [...new Set(ALL_DATA.map(d => d[key] || ""))].filter(Boolean).sort();
        const sel = document.getElementById(id);
        sel.innerHTML = '<option value="">All</option>';
        unique.forEach(v => { const opt = document.createElement("option"); opt.value = v; opt.innerText = v; sel.appendChild(opt); });
      }

      function resetFilters() { 
        document.querySelectorAll(".filter-bar select").forEach(s => s.value = ""); 
        document.querySelectorAll(".filter-bar input").forEach(s => s.value = "");
        render(); 
      }

      function render() { 
        applyFilters(); 
        renderChips();
        renderKPIs(); 
        renderInsights();
        renderCharts(); 
        renderTable(); 
      }

      function applyFilters() {
        const fMod = document.getElementById("f-module").value;
        const fSub = document.getElementById("f-submodule").value;
        const fBen = document.getElementById("f-benzene").value; // <--- ADDED VAR
        const fAss = document.getElementById("f-assignee").value;
        const fSta = document.getElementById("f-status").value;
        const fSev = document.getElementById("f-severity").value;
        const fLab = document.getElementById("f-labels").value; 
        const fStart = document.getElementById("f-start").value;
        const fEnd = document.getElementById("f-end").value;
        const q = document.getElementById("q").value.toLowerCase();

        FILTERED_DATA = ALL_DATA.filter(d => {
          if (fMod && d[KEYS.MODULE] !== fMod) return false;
          if (fSub && d[KEYS.SUBMODULE] !== fSub) return false;
          if (fBen && d[KEYS.BENZENE] !== fBen) return false; // <--- ADDED LOGIC
          if (fAss && d[KEYS.ASSIGNEE] !== fAss) return false;
          if (fSta && d[KEYS.STATUS] !== fSta) return false;
          if (fSev && d[KEYS.SEV] !== fSev) return false;
          if (fLab && d[KEYS.LABELS] !== fLab) return false;
          
          if (fStart && new Date(d[KEYS.CREATED]) < new Date(fStart)) return false;
          if (fEnd && new Date(d[KEYS.CREATED]) > new Date(fEnd)) return false;

          if (q && !JSON.stringify(d).toLowerCase().includes(q)) return false;
          return true;
        });
      }

      function renderChips() {
        const c = document.getElementById("chip-container"); c.innerHTML = "";
        const adds = (id, label) => {
             const el = document.getElementById(id);
             if(el && el.value) {
                c.innerHTML += `<div class="chip"><span>${label}: ${el.value}</span><span class="chip-close" onclick="clearFilter('${id}')">&times;</span></div>`;
             }
        };
        adds("f-module", "Module"); 
        adds("f-submodule", "Sub"); 
        adds("f-benzene", "Benzene"); // <--- ADDED CHIP
        adds("f-assignee", "User");
        adds("f-status", "Status"); adds("f-severity", "Sev"); adds("f-labels", "Label");
        adds("f-start", "From"); adds("f-end", "To");
      }
      function clearFilter(id) { document.getElementById(id).value = ""; render(); }

      function renderKPIs() {
        const d = FILTERED_DATA;
        const total = d.length;
        const open = d.filter(x => !STATUS_CLOSED.includes((x[KEYS.STATUS]||"").toLowerCase())).length;
        const s1 = d.filter(x => isS1(x[KEYS.SEV]) && !STATUS_CLOSED.includes((x[KEYS.STATUS]||"").toLowerCase())).length;
        const s2 = d.filter(x => isS2(x[KEYS.SEV]) && !STATUS_CLOSED.includes((x[KEYS.STATUS]||"").toLowerCase())).length;
        const s3 = d.filter(x => isS3(x[KEYS.SEV]) && !STATUS_CLOSED.includes((x[KEYS.STATUS]||"").toLowerCase())).length;
        const s4 = d.filter(x => isS4(x[KEYS.SEV]) && !STATUS_CLOSED.includes((x[KEYS.STATUS]||"").toLowerCase())).length;
        const un = d.filter(x => !x[KEYS.ASSIGNEE] || x[KEYS.ASSIGNEE] === "Unassigned").length;
        const resolved = d.filter(x => (x[KEYS.STATUS]||"").toLowerCase() === "resolved").length;
        const closed = total - open;
        
        updateKPI("k-total", total); updateKPI("k-open", open); updateKPI("k-s1", s1); updateKPI("k-s2", s2);
        updateKPI("k-s3", s3); updateKPI("k-s4", s4); updateKPI("k-un", un); 
        updateKPI("k-resolved", resolved); updateKPI("k-closed", closed);
      }
      function updateKPI(id, val) { document.getElementById(id).innerText = val; }

      // --- STRATEGIC INSIGHTS RENDERERS ---
      function renderInsights() {
          renderHeatmap();
          renderWatchlist();
      }

      function renderHeatmap() {
          const tbody = document.querySelector("#heatmap-tbl tbody");
          tbody.innerHTML = "";
          const modules = [...new Set(FILTERED_DATA.map(d => d[KEYS.MODULE] || "Other"))].sort();
          
          modules.forEach(m => {
              const rowData = FILTERED_DATA.filter(d => (d[KEYS.MODULE]||"Other") === m);
              const s1 = rowData.filter(d => isS1(d[KEYS.SEV])).length;
              const s2 = rowData.filter(d => isS2(d[KEYS.SEV])).length;
              const s3 = rowData.filter(d => isS3(d[KEYS.SEV])).length;
              const s4 = rowData.filter(d => isS4(d[KEYS.SEV])).length;
              
              const heatColor = (val) => {
                  if(val === 0) return 'transparent';
                  if(val < 3) return '#fee2e2'; // Light Red
                  if(val < 6) return '#fca5a5';
                  return '#ef4444'; // Dark Red
              };
              
              const clk = (sev) => `onclick="drillHeatmap('${m}', '${sev}')"`;

              tbody.innerHTML += `<tr>
                <td>${m}</td>
                <td style="background:${heatColor(s1)}" ${clk('s1')}>${s1 || '-'}</td>
                <td style="background:${heatColor(s2)}" ${clk('s2')}>${s2 || '-'}</td>
                <td style="background:${heatColor(s3)}" ${clk('s3')}>${s3 || '-'}</td>
                <td style="background:${heatColor(s4)}" ${clk('s4')}>${s4 || '-'}</td>
              </tr>`;
          });
      }
      function drillHeatmap(mod, sevType) {
         let sub = FILTERED_DATA.filter(d => (d[KEYS.MODULE]||"Other")===mod);
         if(sevType==='s1') sub = sub.filter(d=>isS1(d[KEYS.SEV]));
         if(sevType==='s2') sub = sub.filter(d=>isS2(d[KEYS.SEV]));
         if(sevType==='s3') sub = sub.filter(d=>isS3(d[KEYS.SEV]));
         if(sevType==='s4') sub = sub.filter(d=>isS4(d[KEYS.SEV]));
         openModal(sub, `Heatmap: ${mod} - ${sevType.toUpperCase()}`);
      }

      function renderWatchlist() {
          const tbody = document.querySelector("#watchlist-tbl tbody");
          tbody.innerHTML = "";
          const now = new Date();
          const risky = FILTERED_DATA.filter(d => {
             const isOpen = !STATUS_CLOSED.includes((d[KEYS.STATUS]||"").toLowerCase());
             if(!isOpen) return false;
             if(!(isS1(d[KEYS.SEV]) || isS2(d[KEYS.SEV]))) return false;
             const age = Math.ceil((now - new Date(d[KEYS.CREATED])) / (1000 * 60 * 60 * 24));
             return age > 5;
          }).sort((a,b) => new Date(a[KEYS.CREATED]) - new Date(b[KEYS.CREATED]));

          risky.slice(0, 10).forEach(d => {
              const age = Math.ceil((now - new Date(d[KEYS.CREATED])) / (1000 * 60 * 60 * 24));
              tbody.innerHTML += `<tr class="watchlist-row" onclick="window.open('${d.URL}', '_blank')">
                  <td><strong>${d.Key}</strong></td>
                  <td>${d.Summary.substring(0,30)}...</td>
                  <td>${d[KEYS.ASSIGNEE]}</td>
                  <td style="font-weight:bold; color:#b91c1c;">${age} days</td>
              </tr>`;
          });
      }

      // --- EXISTING CHART RENDERERS ---
      function renderCharts() {
        const container = document.getElementById("charts-container");
        container.innerHTML = "";
        
        // 1. Dynamic Pivots
        CONFIG_PIVOTS.forEach((p, idx) => {
            const chartId = `c-dyn-${idx}`;
            const card = document.createElement("div");
            card.className = "chart-card";
            card.innerHTML = `<div class="chart-title">Pivot ${idx+1}: ${p.x} vs ${p.stack}</div><canvas id="${chartId}"></canvas>`;
            container.appendChild(card);
            createStacked(chartId, p.x, p.stack);
        });

        // 2. Fixed Charts
        const ageId = "c-ageing";
        const wId = "c-workload";
        const ageCard = document.createElement("div");
        ageCard.className = "chart-card";
        ageCard.innerHTML = `<div class="chart-title">Defect Ageing (Open Issues)</div><canvas id="${ageId}"></canvas>`;
        container.appendChild(ageCard);
        
        const wCard = document.createElement("div");
        wCard.className = "chart-card";
        wCard.innerHTML = `<div class="chart-title">Assignee Workload (Open S1/S2)</div><canvas id="${wId}"></canvas>`;
        container.appendChild(wCard);

        createAgeingChart(ageId);
        createWorkloadChart(wId);
      }

      function createStacked(id, dimX, dimStack) {
        if(CHARTS[id]) CHARTS[id].destroy();
        const ctx = document.getElementById(id);
        const lx = [...new Set(FILTERED_DATA.map(d=>d[dimX]||"Other"))].sort();
        const ls = [...new Set(FILTERED_DATA.map(d=>d[dimStack]||"Other"))].sort();
        const ds = ls.map((st, i) => ({ label: st, data: lx.map(x => FILTERED_DATA.filter(d => (d[dimX]||"Other")===x && (d[dimStack]||"Other")===st).length), backgroundColor: getHslaColor(i, ls.length) }));
        CHARTS[id] = new Chart(ctx, { type: 'bar', data: { labels: lx, datasets: ds }, options: { responsive:true, maintainAspectRatio:false, scales:{x:{stacked:true},y:{stacked:true}}, onClick: (e, els) => { if(!els.length)return; const xVal=lx[els[0].index], sVal=ds[els[0].datasetIndex].label; openModal(FILTERED_DATA.filter(d=>(d[dimX]||"Other")===xVal && (d[dimStack]||"Other")===sVal), `Drill Down: ${xVal}-${sVal}`); } } });
      }
      function createAgeingChart(id) {
        if(CHARTS[id]) CHARTS[id].destroy();
        const now=new Date(), b={"< 5 Days":0, "5-15 Days":0, "15-30 Days":0, "> 30 Days":0};
        const open = FILTERED_DATA.filter(d=>!STATUS_CLOSED.includes((d[KEYS.STATUS]||"").toLowerCase()) && d[KEYS.CREATED]);
        open.forEach(d=>{ const diff=Math.ceil((now-new Date(d[KEYS.CREATED]))/86400000); if(diff<=5)b["< 5 Days"]++; else if(diff<=15)b["5-15 Days"]++; else if(diff<=30)b["15-30 Days"]++; else b["> 30 Days"]++; });
        CHARTS[id] = new Chart(document.getElementById(id), { type:'doughnut', data:{labels:Object.keys(b),datasets:[{data:Object.values(b),backgroundColor:['#22c55e','#eab308','#f97316','#ef4444']}]}, options:{responsive:true, maintainAspectRatio:false, onClick:(e,els)=>{ if(!els.length)return; const l=Object.keys(b)[els[0].index]; openModal(open.filter(d=>{ const diff=Math.ceil((now-new Date(d[KEYS.CREATED]))/86400000); if(l==="< 5 Days")return diff<=5; if(l==="5-15 Days")return diff>5&&diff<=15; if(l==="15-30 Days")return diff>15&&diff<=30; return diff>30; }), `Ageing: ${l}`); } } });
      }
      function createWorkloadChart(id) {
        if(CHARTS[id]) CHARTS[id].destroy();
        const c={}; const t=FILTERED_DATA.filter(d=>!STATUS_CLOSED.includes((d[KEYS.STATUS]||"").toLowerCase()) && (isS1(d[KEYS.SEV])||isS2(d[KEYS.SEV])));
        t.forEach(d=>{ const u=d[KEYS.ASSIGNEE]||"Unassigned"; c[u]=(c[u]||0)+1; });
        const s=Object.entries(c).sort((a,b)=>b[1]-a[1]).slice(0,10);
        CHARTS[id]=new Chart(document.getElementById(id), { type:'bar', data:{labels:s.map(x=>x[0]),datasets:[{label:'Critical/High',data:s.map(x=>x[1]),backgroundColor:'#3b82f6'}]}, options:{indexAxis:'y', responsive:true, maintainAspectRatio:false, onClick:(e,els)=>{ if(!els.length)return; const u=s[els[0].index][0]; openModal(t.filter(d=>(d[KEYS.ASSIGNEE]||"Unassigned")===u), `Workload: ${u}`); } } });
      }
      
      function drillKPI(type) {
        const isOpen = d => !STATUS_CLOSED.includes((d[KEYS.STATUS]||"").toLowerCase());
        let subset=[], title="";
        if (type==='total') { subset=FILTERED_DATA; title="All Defects"; }
        if (type==='open') { subset=FILTERED_DATA.filter(isOpen); title="Open Issues"; }
        if (type==='s1') { subset=FILTERED_DATA.filter(d=>isS1(d[KEYS.SEV])&&isOpen(d)); title="Open S1-Critical"; }
        if (type==='s2') { subset=FILTERED_DATA.filter(d=>isS2(d[KEYS.SEV])&&isOpen(d)); title="Open S2-Serious"; }
        if (type==='s3') { subset=FILTERED_DATA.filter(d=>isS3(d[KEYS.SEV])&&isOpen(d)); title="Open S3-Moderate"; }
        if (type==='s4') { subset=FILTERED_DATA.filter(d=>isS4(d[KEYS.SEV])&&isOpen(d)); title="Open S4-Tolerable"; }
        if (type==='unassigned') { subset=FILTERED_DATA.filter(d=>!d[KEYS.ASSIGNEE]||d[KEYS.ASSIGNEE]==="Unassigned"); title="Unassigned"; }
        if (type==='resolved') { subset=FILTERED_DATA.filter(d=>(d[KEYS.STATUS]||"").toLowerCase()==="resolved"); title="Resolved Issues"; }
        if (type==='closed') { subset=FILTERED_DATA.filter(d=>STATUS_CLOSED.includes((d[KEYS.STATUS]||"").toLowerCase())); title="Closed"; }
        openModal(subset, title);
      }

      function isS1(s) { const v=(s||"").toLowerCase(); return v.includes("s1") || v.includes("critical") || v.includes("high") || v.includes("p0"); }
      function isS2(s) { const v=(s||"").toLowerCase(); return v.includes("s2") || v.includes("medium") || v.includes("p1") || v.includes("serious"); }
      function isS3(s) { const v=(s||"").toLowerCase(); return v.includes("s3") || v.includes("moderate") || v.includes("p2") || v.includes("normal"); }
      function isS4(s) { const v=(s||"").toLowerCase(); return v.includes("s4") || v.includes("tolerable") || v.includes("p3") || v.includes("low"); }
      function getHslaColor(i, t) { return `hsla(${(i*137.5)%360}, 65%, 55%, 0.8)`; }
      
      // MODIFIED: Direct window open instead of form submission
      function submitFakeForm(url) {
        if (!url || url.length < 5) { alert("Invalid URL"); return; }
        window.open(url, '_blank');
      }

      function renderTable() {
        const tbody = document.querySelector("#main-table tbody");
        tbody.innerHTML = "";
        const limit = parseInt(document.getElementById("row-limit").value);
        document.getElementById("table-count").innerText = `(Showing ${Math.min(limit, FILTERED_DATA.length)} of ${FILTERED_DATA.length})`;
        
        FILTERED_DATA.slice(0, limit).forEach(d => {
          tbody.innerHTML += `<tr>
            <td onclick="submitFakeForm('${d.URL}')"><span class="clickable-key">${d.Key}</span></td>
            <td>${d.Summary.substring(0, 50)}...</td>
            <td>${d[KEYS.MODULE]}</td><td>${d[KEYS.SUBMODULE]}</td>
            <td>${d[KEYS.BENZENE]}</td>
            <td>${d[KEYS.SEV]}</td><td>${d[KEYS.STATUS]}</td><td>${d[KEYS.ASSIGNEE]}</td>
            <td style="text-align:right"><button class="concrete-btn" onclick="submitFakeForm('${d.URL}')">Open â†—</button></td>
          </tr>`;
        });
      }

      function openModal(data, title) {
        MODAL_DATA = data;
        document.getElementById("modal-title").innerText = `${title} (${data.length})`;
        const tbody = document.querySelector("#modal-table tbody");
        tbody.innerHTML = "";
        data.forEach(d => {
          const date = d[KEYS.CREATED] ? new Date(d[KEYS.CREATED]).toLocaleDateString() : "";
          tbody.innerHTML += `<tr>
            <td onclick="submitFakeForm('${d.URL}')"><span class="clickable-key">${d.Key}</span></td>
            <td>${d.Summary}</td><td>${d[KEYS.STATUS]}</td><td>${d[KEYS.SEV]}</td>
            <td>${d[KEYS.ASSIGNEE]}</td><td>${d[KEYS.MODULE]}</td><td>${date}</td>
            <td style="text-align:right"><button class="concrete-btn" onclick="submitFakeForm('${d.URL}')">Open â†—</button></td>
          </tr>`;
        });
        document.getElementById("drill-modal").style.display = "flex";
      }
      function closeModal() { document.getElementById("drill-modal").style.display = "none"; }
      
      function exportPDF(source) {
        const { jsPDF } = window.jspdf; const doc = new jsPDF('l'); 
        let title="", data=[];
        if (source==='modal') { title=document.getElementById("modal-title").innerText; data=MODAL_DATA; }
        else { title="Dashboard Export"; data=FILTERED_DATA; }
        doc.text(title, 14, 15);
        const rows = data.map(d => [d.Key, d.Summary.substring(0,30), d[KEYS.STATUS], d[KEYS.SEV], d[KEYS.ASSIGNEE], d[KEYS.MODULE]]);
        doc.autoTable({ head:[['Key','Summary','Status','Severity','Assignee','Module']], body:rows, startY:20 });
        doc.save(`${title.replace(/ /g,"_")}.pdf`);
      }

      function exportExcel() {
        let csvContent = "data:text/csv;charset=utf-8,";
        const keys = Object.values(KEYS);
        csvContent += keys.join(",") + "\r\n";
        
        FILTERED_DATA.forEach(row => {
            const rowStr = keys.map(k => {
                let val = row[k] ? row[k].toString().replace(/"/g, '""') : "";
                if(val.includes(",")) val = `"${val}"`;
                return val;
            }).join(",");
            csvContent += rowStr + "\r\n";
        });
        
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "jira_data_export.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }
      
      function handleSearch(el) {
        const val = el.value.toLowerCase();
        const list = document.getElementById("suggestions"); list.innerHTML = "";
        if(val.length < 3) return;
        const matches = ALL_DATA.filter(d => d.Key.toLowerCase().includes(val) || d.Summary.toLowerCase().includes(val)).slice(0,5);
        matches.forEach(m => { const op = document.createElement("option"); op.value = m.Key; op.label = m.Summary.substring(0,40); list.appendChild(op); });
        render(); 
      }
      function checkEnter(e) { if(e.key === "Enter") { const val = document.getElementById("q").value.trim(); const match = ALL_DATA.find(d => d.Key.toLowerCase() === val.toLowerCase()); if(match) submitFakeForm(match.URL); } }

      window.onload = loadData;
    </script>
  </body>
</html>